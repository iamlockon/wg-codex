apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: core
  namespace: wg-vpn
spec:
  selector:
    matchLabels:
      app: core
  template:
    metadata:
      labels:
        app: core
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: core
          image: ghcr.io/replace-me/wg-core:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 50051
              hostPort: 50051
            - containerPort: 51820
              hostPort: 51820
              protocol: UDP
          envFrom:
            - configMapRef:
                name: core-config
          env:
            - name: CORE_NODE_ID_FILE
              value: /var/run/secrets/core-sensitive/CORE_NODE_ID
            - name: ADMIN_API_TOKEN_FILE
              value: /var/run/secrets/core-sensitive/ADMIN_API_TOKEN
            - name: WG_SERVER_PUBLIC_KEY_FILE
              value: /var/run/secrets/core-sensitive/WG_SERVER_PUBLIC_KEY
            - name: WG_PRIVATE_KEY_PATH
              value: /etc/wireguard/private.key
            - name: CORE_TLS_CERT_PATH
              value: /etc/core-tls/server.crt
            - name: CORE_TLS_KEY_PATH
              value: /etc/core-tls/server.key
            - name: CORE_TLS_CLIENT_CA_CERT_PATH
              value: /etc/core-tls/ca.pem
          volumeMounts:
            - name: core-sensitive
              mountPath: /var/run/secrets/core-sensitive
              readOnly: true
            - name: core-tls
              mountPath: /etc/core-tls
              readOnly: true
            - name: wireguard-keys
              mountPath: /etc/wireguard
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
              add:
                - NET_ADMIN
                - NET_RAW
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
      volumes:
        - name: core-sensitive
          secret:
            secretName: core-secrets
            items:
              - key: ADMIN_API_TOKEN
                path: ADMIN_API_TOKEN
              - key: CORE_NODE_ID
                path: CORE_NODE_ID
              - key: WG_SERVER_PUBLIC_KEY
                path: WG_SERVER_PUBLIC_KEY
        - name: core-tls
          secret:
            secretName: core-tls
        - name: wireguard-keys
          secret:
            secretName: wireguard-keys
            items:
              - key: private.key
                path: private.key
---
apiVersion: v1
kind: Service
metadata:
  name: core
  namespace: wg-vpn
spec:
  selector:
    app: core
  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
